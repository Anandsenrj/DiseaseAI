<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Disease Finder ‚Äî Final</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Page animations */
    .page-enter { animation: fadeSlide 0.5s ease both; }
    @keyframes fadeSlide { from { opacity: 0; transform: translateY(14px); } to { opacity:1; transform: translateY(0);} }

    .glass { background: rgba(255,255,255,0.94); backdrop-filter: blur(10px); }
    .float-soft { transition: transform .32s ease, box-shadow .32s ease; }
    .float-soft:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 14px 40px rgba(15,23,42,0.12); }

    .disease-img { width: 180px; height: 180px; object-fit: cover; border-radius: 12px; }
    @media (max-width:768px){ .disease-img{ width:120px; height:120px } }

    /* Print friendly */
    @media print {
      body { background: white !important; }
      nav, #controls { display: none !important; }
      #reportCard { box-shadow: none !important; border: none !important; }
    }

    /* Small helper for subtle entrance */
    .fade-up { transform: translateY(8px); opacity: 0; animation: fadeUpIn .5s forwards; }
    @keyframes fadeUpIn { to { transform: translateY(0); opacity: 1; } }

  </style>
</head>
<body class="page-enter bg-gradient-to-b from-slate-50 to-white min-h-screen">

  <!-- NAVBAR -->
  <nav class="w-full bg-white/60 glass sticky top-0 z-40 shadow-sm">
    <div class="max-w-[1200px] mx-auto px-4 md:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-indigo-600 text-white rounded-lg flex items-center justify-center font-bold">DF</div>
        <div>
          <div class="text-lg font-semibold text-slate-900">Disease Finder</div>
          <div class="text-xs text-slate-500">Wikipedia-powered, NLP extraction</div>
        </div>
      </div>

      <div id="controls" class="flex items-center gap-3">
        <button id="shareBtn" class="px-3 py-2 rounded-md border text-sm hover:bg-indigo-50">Share</button>
        <button id="savePngBtn" class="px-3 py-2 rounded-md border text-sm hover:bg-indigo-50">Save PNG</button>
        <button id="printBtn" class="px-3 py-2 rounded-md border text-sm hover:bg-indigo-50">Print</button>
        <button id="pdfBtn" class="px-3 py-2 rounded-md bg-indigo-600 text-white text-sm">Save PDF</button>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="max-w-[1200px] mx-auto px-4 md:px-6 py-8">

    <!-- SEARCH CARD -->
    <section class="glass p-6 rounded-2xl shadow-md mb-6">
      <div class="flex flex-col md:flex-row md:items-center gap-4">
        <div class="flex-1">
          <label class="text-sm text-slate-600">Search disease</label>
          <input id="query" class="w-full mt-2 p-4 rounded-xl border outline-none" placeholder="Type disease name (e.g., Dengue, Cataract)" />
        </div>

        <div class="flex gap-3">
          <button id="searchBtn" onclick="searchDisease()" class="px-5 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition">üîç Search</button>
          <button id="clearBtn" onclick="clearResults()" class="px-4 py-3 border rounded-xl">Clear</button>
        </div>
      </div>
    </section>

    <!-- OUTPUT -->
    <section id="output" class="min-h-[220px]"></section>

  </main>

<script>
// ----- helpers -----
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// ----- clear -----
function clearResults(){ document.getElementById('output').innerHTML = `<div class="glass p-6 rounded-2xl text-center text-slate-600">Search a disease to see full details.</div>`; }
clearResults();

// ----- search -----
async function searchDisease(){
  const q = document.getElementById('query').value.trim();
  const out = document.getElementById('output');
  if(!q) return alert('Please enter a disease name.');

  out.innerHTML = `<div class="glass p-6 rounded-2xl text-center">‚è≥ Fetching Wikipedia‚Ä¶</div>`;

  try{
    const sres = await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(q));
    if(!sres.ok) { out.innerHTML = `<div class="glass p-6 rounded-2xl text-center text-red-600">Disease not found.</div>`; return; }
    const summary = await sres.json();
    // fetch mobile sections too for more content
    let combined = summary.extract || '';
    try{
      const mres = await fetch('https://en.wikipedia.org/api/rest_v1/page/mobile-sections/' + encodeURIComponent(q));
      if(mres.ok){ const m = await mres.json(); const sections = [...(m.lead?.sections||[]), ...(m.remaining?.sections||[])]; sections.forEach(s=> combined += '\n' + (s.text||'')); }
    }catch(e){}

    out.innerHTML = `<div class="glass p-6 rounded-2xl text-center">‚öïÔ∏è Extracting medical sections‚Ä¶</div>`;

    const apiRes = await fetch('/api/extract',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ combinedText: combined }) });
    const ai = await apiRes.json();

    // build sections
    function block(title, items){ if(!items || !items.length) return ''; return `\n<div class="mb-4">\n  <h4 class="text-indigo-600 font-semibold mb-2">${escapeHtml(title)}</h4>\n  <ul class="list-disc ml-5 text-slate-700">${items.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}\n  </ul>\n</div>`; }

    const img = summary.thumbnail?.source || '';

    out.innerHTML = `
      <article id="reportCard" class="glass p-6 rounded-2xl shadow-md float-soft">
        <div class="grid md:grid-cols-3 gap-6">
          <div class="text-center md:text-left">
            ${img? `<img src="${img}" class="disease-img mb-4 shadow-md"/>` : `<div class="disease-img bg-gray-200 mb-4"></div>`}
            <h2 class="text-2xl font-bold mb-1">${escapeHtml(summary.title)}</h2>
            <a href="${summary.content_urls?.desktop?.page || '#'}" target="_blank" class="text-sm text-indigo-600 underline">Open on Wikipedia</a>
            <p class="text-sm mt-3 text-slate-700">${escapeHtml(summary.extract||'')}</p>
          </div>

          <div class="md:col-span-2">
            ${block('Symptoms', ai.symptoms)}
            ${block('Causes', ai.causes)}
            ${block('Risk Factors', ai.risk_factors)}
            ${block('Diagnosis', ai.diagnosis)}
            ${block('Complications', ai.complications)}
            ${block('Treatments', ai.treatments)}
            ${block('Prevention', ai.prevention)}

            <div class="mt-4 p-4 bg-indigo-50 border-l-4 border-indigo-600 rounded">
              <h4 class="font-semibold">When to See a Doctor</h4>
              <p class="text-sm text-slate-700 mt-1">${escapeHtml(ai.when_to_see_a_doctor||'See a doctor if symptoms worsen.')}</p>
            </div>
          </div>
        </div>
      </article>
    `;

    // slight entrance animation
    const card = document.getElementById('reportCard');
    if(card){ card.classList.add('fade-up'); }

  }catch(err){ console.error(err); out.innerHTML = `<div class="glass p-6 rounded-2xl text-center text-red-600">Extraction failed.</div>`; }
}

// ----- PDF export -----
document.getElementById('pdfBtn').addEventListener('click', async ()=>{
  const card = document.getElementById('reportCard'); if(!card) return alert('No report to save.');
  const canvas = await html2canvas(card, { scale: 2, useCORS: true, backgroundColor: null });
  const img = canvas.toDataURL('image/png');
  const pdf = new jspdf.jsPDF('p','mm','a4');
  pdf.addImage(img,'PNG',10,10,190,(canvas.height*190)/canvas.width);
  pdf.save((document.querySelector('#reportCard h2')?.textContent||'report').replace(/\s+/g,'_') + '.pdf');
});

// ----- Save PNG -----
document.getElementById('savePngBtn').addEventListener('click', async ()=>{
  const card = document.getElementById('reportCard'); if(!card) return alert('No report to save.');
  const canvas = await html2canvas(card, { scale: 2, useCORS: true, backgroundColor: null });
  const link = document.createElement('a'); link.download = (document.querySelector('#reportCard h2')?.textContent||'report').replace(/\s+/g,'_') + '.png';
  link.href = canvas.toDataURL('image/png'); link.click();
});

// ----- Print -----
document.getElementById('printBtn').addEventListener('click', ()=>{ window.print(); });

// ----- Share -----
document.getElementById('shareBtn').addEventListener('click', async ()=>{
  const card = document.getElementById('reportCard'); if(!card) return alert('No report to share.');
  // try Web Share API (share text + url)
  const title = document.querySelector('#reportCard h2')?.textContent || 'Disease Report';
  const txt = title + '\nRead more: ' + (document.querySelector('#reportCard a')?.href || '');
  if(navigator.share){ try{ await navigator.share({ title, text: txt, url: location.href }); }catch(e){ alert('Share canceled'); } }
  else { await navigator.clipboard.writeText(txt); alert('Report info copied to clipboard.'); }
});

// ----- Clear button -----
// Already wired above

</script>
</body>
</html>
